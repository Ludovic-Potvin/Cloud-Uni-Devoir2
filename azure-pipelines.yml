# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool: "Azure Pipelines"

variables:
  - name: CloudInitContent

  - name: AzureAppInfrastructure
    value: 'AzureResourceGroup1/AzureResourceGroup1'

  - name: resourceGroupName
    value: 'Lupo'

  - name: rgLocation
    value: 'Canada Central'

  - name: AzureAppFunction
    value: 'Function'

  - name: AzureFunctionAppName
    value: 'LupoFunctionApp'

stages:
- stage: Infra
  displayName: Infrastructure Deployment
  jobs:
  - job: Infra
    displayName: Infrastructure Deployment
    steps:
    - task: AzureResourceManagerTemplateDeployment@3
      displayName: ARM Template Deployment
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: 'Azure subscription 1(f8ee07ed-b563-4b27-931f-56bdf1405242)'
        subscriptionId: 'f8ee07ed-b563-4b27-931f-56bdf1405242'
        action: 'Create Or Update Resource Group'
        resourceGroupName: '$(resourceGroupName)'
        location: '$(rgLocation)'
        templateLocation: 'Linked artifact'
        csmFile: '$(Build.SourcesDirectory)/$(AzureAppInfrastructure)/azuredeploy.json'
        csmParametersFile: '$(Build.SourcesDirectory)/$(AzureAppInfrastructure)/azuredeploy.parameters.json'
        overrideParameters: '-name $(AzureFunctionAppName) -resourceGroup $(resourceGroupName)'
        deploymentMode: 'Incremental'
